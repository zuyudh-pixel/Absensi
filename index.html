<!--
 * ABSENSI - GOOGLE SCRIPT
 * ***********************************************************************************
 * Code by    : fahroni|ganteng
 * Contact me : fahroniganteng@gmail.com
 * YouTube    : https://www.youtube.com/c/FahroniGanteng
 * Github     : https://github.com/fahroniganteng
 * Date       : Jul 2021
 * License    : MIT
-->
<!DOCTYPE html>
<html>

<head>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
	<base target="_top">
	<meta name="viewport" content="width=device-width, initial-scale=1">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css" />
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>
</head>

<body class="bg-light">
	<div class="container">
		<div class="py-5 text-center">
			<img class="d-block mx-auto mb-4" src="data:image/png;base64, <?!=dt.logo?>" alt="" width="80">
			<h4>
				<b><?!=dt.perusahaan?></b>
			</h4>

      <!-- SILAKAN HAPUS BAGIAN INI UNTUK MENGHILANGKAN INFO APLIKASI ------------------------------------------------>
      <p>
        UNIVERSITAS ISLAM NEGERI<br>
        KIAI AGENG MUHAMMAD BESARI<br>
        PONOROGO<br>
       
      </p>
      <!-- AKHIR HAPUS INFO ------------------------------------------------------------------------------------------->
    </div>

		<form class="row" onsubmit="submitAbsensi();return false;">
			<div class="col-md-12">
				<h4 class="mb-3">Absensi Dosen</h4>
				<div class="mb-3">
   <label><b>Scan Barcode ID Dosen:</b><br></label>
  <div id="reader" style="width:100%"></div>
  <!--<small class="text-muted">Arahkan kamera ke barcode ID dosen</small>--------------------->
</div>

<input type="hidden" id="idPegawai">
<input type="hidden" id="password">
				<div class="mb-3">
					<label><b>Absensi:</b></label><br>
					<div class="form-check form-check-inline">
						<input class="form-check-input" type="radio" name="absensi" id="absensi1" value="Masuk" required>
						<label class="form-check-label" for="absensi1">Masuk</label>
					</div>
					<div class="form-check form-check-inline">
						<input class="form-check-input" type="radio" name="absensi" id="absensi2" value="Pulang">
						<label class="form-check-label" for="absensi2">Pulang</label>
					</div>
          <div class="form-check form-check-inline">
						<input class="form-check-input" type="radio" name="absensi" id="absensi3" value="Ijin" required>
						<label class="form-check-label" for="absensi3">Ijin, Sakit, Dinas Luar</label>
					</div>
				</div>
				<div class="mb-3">
					<label><b>Lokasi & Status Absensi:</b></label><br>
          <!--
            Jika menambah list Lokasi & status absensi, sesuaikan juga pada kode.gs fungsi validDistance()
          -->
					<div class="form-check form-check-inline">
						<input class="form-check-input" type="radio" name="workFrom" id="workFrom2" value="WFO" required>
						<label class="form-check-label" for="workFrom2">WFO (Kampus)</label>
					</div>
			
          <div class="form-check form-check-inline">
						<input class="form-check-input" type="radio" name="workFrom" id="workFrom1" value="WFH">
						<label class="form-check-label" for="workFrom1">WFA</label>
					</div>
          <div class="form-check form-check-inline">
						<input class="form-check-input" type="radio" name="workFrom" id="workFrom5" value="Ijin">
						<label class="form-check-label" for="workFrom5">Ijin, Sakit, Dinas Luar</label>
					</div>
				</div>
				<div class="mb-3">
					<label for="kegiatan"><b>Mengampu Kelas:</b></label>
					<textarea class="form-control" id="kegiatan" placeholder="Diisi saat pulang, Contoh: 25.MHKI.A, 25.MHKI.B,..." rows="1"></textarea>
				</div>
				<hr class="mb-4">
				<div class="alert alert-success" role="alert" style="display:none"></div>
				<div class="alert alert-warning" role="alert" style="display:none">
					<h5>Perhatian!</h5>
					<p>Anda harus mengijinkan akses lokasi pada browser agar bisa melakukan absensi</p>
				</div>
				<button class="btn btn-primary btn-lg btn-block" type="submit"><i class="fas fa-fingerprint mr-2"></i> Kirim Absensi</button>

<a href="https://script.google.com/macros/s/AKfycbxR1gH4G9kBl9GqYx83t4NLIr4vZskCkpadz9rdNK0/dev" target="" class="mr-2">
          <i class=""></i><small class="">Klik disini untuk absensi lagi! [Refresh]</small>
        </a>

			</div>
		</form>
		<footer class="my-5 pt-5 text-muted text-center text-small">
			<p class="mb-1">
        Copyright &copy; 2026 <?!=dt.perusahaan?>. All rights reserved
			</p>
		</footer>
	</div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.0.18/sweetalert2.all.min.js"></script>
	<script>
		function loading(){
      $('.btn').attr('disabled', true).html('<i class="fas fa-spinner fa-pulse mr-2"></i> Mengirim...');
    }
    function unloading(){
      $('.btn').removeAttr('disabled').html('<i class="fas fa-fingerprint mr-2"></i> Mengirim Absensi');
    }

		function submitAbsensi() {
      loading();
			if (navigator.geolocation){
        $('.alert-warning').show();
        navigator.geolocation.getCurrentPosition(simpanDataAbsensi, errorGetLocation);
      }
		}
    function errorGetLocation(){
      $('.alert-warning').show();
      Swal.fire({
        title: 'Absensi gagal!',
        text: 'Anda belum/tidak mengizinkan akses lokasi.',
        icon: 'error',
        confirmButtonText: 'OK'
      })
      unloading();
    }
		function simpanDataAbsensi(position) {
      $('.alert-warning').hide();
			let data = {
				idPegawai: $('#idPegawai').val(),
				password: $('#password').val(),
				kegiatan: $('#kegiatan').val(),
				absensi: $('input[name=absensi]:checked', 'form').val(),
				workFrom: $('input[name=workFrom]:checked', 'form').val(),
				position: [
					position.coords.latitude,
					position.coords.longitude
				]
			};
			// console.log(data);
			if (data.absensi == 'Pulang' && data.kegiatan.length < 1) {
				Swal.fire({
					title: 'Error!',
					text: 'Bpk/Ibu belum mengisi kelas yang diampu.',
					icon: 'error',
					confirmButtonText: 'OK'
				})
        unloading();
			}
			else 
				google.script.run.withSuccessHandler(callbackAbsensi).submitAbsensi(data);
		}
		function callbackAbsensi(dt) {
			if (dt.success) {
				Swal.fire({
					title: 'Sukses!',
					html: '<b>Yth. ' + dt.msg + '!</b><br>Data absensi sudah disimpan.',
					icon: 'success',
					confirmButtonText: 'OK'
				})
				$('.form-control').val('');
			}
			else {
				$('#password').val('');
				Swal.fire({
					title: 'Gagal!',
					html: dt.msg,
					icon: 'error',
					confirmButtonText: 'OK'
				})
			}
			unloading();
		}
    // ===== SCANNER BARCODE =====
function onScanSuccess(decodedText, decodedResult) {
  
  /*
    Format barcode:
    NIDN|PASSWORD
    Contoh:
    0123456789|dosen123
  */

  let data = decodedText.split("|");

  if (data.length === 2) {
    $("#idPegawai").val(data[0]);
    $("#password").val(data[1]);

    Swal.fire({
      title: "Berhasil Scan!",
      html: "Nomor Induk Dosen: <b>" + data[0] + "</b>",
      icon: "success",
      timer: 2000,
      showConfirmButton: false
    });

    html5QrcodeScanner.clear();
  } else {
    Swal.fire({
      title: "Barcode Tidak Dikenal!",
      text: "Mungkin belum terdaftar.",
      icon: "error"
    });
  }
}

let html5QrcodeScanner = new Html5QrcodeScanner(
  "reader",
  { fps: 10, qrbox: 250 }
);

html5QrcodeScanner.render(onScanSuccess);

function refreshPage() {
  location.reload(true);
}

	</script>
</body>
</html>
